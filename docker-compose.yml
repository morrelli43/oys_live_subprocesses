services:
  contact-sync:
    build: ./contact-sync
    image: ghcr.io/morrelli43/oys_live_subprocesses:${IMAGE_TAG:-main}
    container_name: "contact-sync"
    restart: unless-stopped
    environment:
      - ENABLE_GOOGLE=${ENABLE_GOOGLE:-true}
      - ENABLE_SQUARE=${ENABLE_SQUARE:-true}
      - SQUARE_ACCESS_TOKEN=${SQUARE_ACCESS_TOKEN}
      - SQUARE_WEBHOOK_URL=${SQUARE_WEBHOOK_URL}
      - SQUARE_SIGNATURE_KEY=${SQUARE_SIGNATURE_KEY}
      - WEBFORM_STORAGE=${WEBFORM_STORAGE:-/app/env_files/webform_contacts.json}
      - GOOGLE_CREDENTIALS_FILE=${GOOGLE_CREDENTIALS_FILE:-/app/env_files/credentials-test.json}
      - GOOGLE_TOKEN_FILE=${GOOGLE_TOKEN_FILE:-/app/env_files/token.json}
      - GRIST_API_KEY=${GRIST_API_KEY}
    volumes:
      # Mount the user's specific data directory to /app/env_files
      - ~/dockerhub/permadata/oys_contacts/env_files:/app/env_files
    ports:
      - "${SYNC_SERVICE_PORT:-7173}:${SYNC_SERVICE_PORT:-7173}"

  email-service:
    build: ./email-service
    image: ghcr.io/morrelli43/oys_live_subprocesses_email_service:${IMAGE_TAG:-main}
    container_name: "email-service"
    restart: unless-stopped
    environment:
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT:-465}
      - SMTP_SECURE=${SMTP_SECURE:-true}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM=${SMTP_FROM}
      - EMAIL_RECIPIENT=${EMAIL_RECIPIENT:-bookings@onyascoot.com}
    ports:
      - "${EMAIL_SERVICE_PORT:-3002}:${EMAIL_SERVICE_PORT:-3002}"
    depends_on:
      - contact-sync

  node-box:
    build: ./node-box
    image: ghcr.io/morrelli43/oys_live_subprocesses_node_box:${IMAGE_TAG:-main}
    container_name: "node-box"
    restart: unless-stopped
    environment:
      - PUSH_WEBHOOK_URL=${N8N_WEBHOOK_URL:-https://hooks.morrelli43media.com/webhook/message-center}
      - PORT=3003
    ports:
      - "${NODE_BOX_PORT:-3003}:3003"

  message-router:
    build: ./message-router
    image: ghcr.io/morrelli43/oys_live_subprocesses_message_router:${IMAGE_TAG:-main}
    container_name: "message-router"
    restart: unless-stopped
    environment:
      - PORT=3001
      - CONTACT_SYNC_URL=http://contact-sync:7173/submit
      - EMAIL_SERVICE_URL=http://email-service:3002/send-email
      - NODE_BOX_URL=http://node-box:3003/push
    ports:
      - "${MESSAGE_ROUTER_PORT:-3001}:3001"
    depends_on:
      - contact-sync
      - email-service
      - node-box

networks:
  default:
    name: ${FRONTEND_LIVE:-oys_frontend_live}
    external: true
